#include "PatientManageWidget.h"
#include "../common/UIStyleManager.h"
#include <QSplitter>
#include <QDateTime>
#include <QFileDialog>
#include <QTextStream>
#include <QDate>
#include <QFile>
#include <QGridLayout>
#include <QRegularExpression>
#include <QStringConverter>

PatientManageWidget::PatientManageWidget(QWidget *parent)
    : QWidget(parent)
    , m_mainLayout(nullptr)
    , m_dbManager(nullptr)
{
    setupUI();
}

void PatientManageWidget::setDatabaseManager(DatabaseManager* dbManager)
{
    m_dbManager = dbManager;
    loadPatients();
}

void PatientManageWidget::setupUI()
{
    m_mainLayout = new QVBoxLayout(this);
    m_mainLayout->setContentsMargins(15, 15, 15, 15);
    m_mainLayout->setSpacing(15);
    
    // Ê†áÈ¢ò
    QLabel* titleLabel = new QLabel("ÊÇ£ËÄÖÁÆ°ÁêÜ", this);
    titleLabel->setStyleSheet("font-size: 18px; font-weight: bold; color: #2C3E50; margin-bottom: 10px;");
    m_mainLayout->addWidget(titleLabel);
    
    // È°∂ÈÉ®Â∑•ÂÖ∑Ê†è
    m_toolLayout = new QHBoxLayout;
    m_toolLayout->setSpacing(10);
    
    m_btnAdd = new QPushButton("‚ûï Êñ∞Â¢ûÊÇ£ËÄÖ", this);
    m_btnEdit = new QPushButton("‚úèÔ∏è ÁºñËæëÊÇ£ËÄÖ", this);
    m_btnDelete = new QPushButton("üóëÔ∏è Âà†Èô§ÊÇ£ËÄÖ", this);
    m_btnRefresh = new QPushButton("üîÑ Âà∑Êñ∞", this);
    m_btnExport = new QPushButton("üì§ ÂØºÂá∫", this);
    m_btnViewHistory = new QPushButton("üìã Êü•ÁúãÂéÜÂè≤", this);
    
    UIStyleManager::applyButtonStyle(m_btnAdd, "primary");
    UIStyleManager::applyButtonStyle(m_btnEdit, "secondary");
    UIStyleManager::applyButtonStyle(m_btnDelete, "error");
    UIStyleManager::applyButtonStyle(m_btnRefresh, "secondary");
    UIStyleManager::applyButtonStyle(m_btnExport, "secondary");
    UIStyleManager::applyButtonStyle(m_btnViewHistory, "secondary");
    
    m_toolLayout->addWidget(m_btnAdd);
    m_toolLayout->addWidget(m_btnEdit);
    m_toolLayout->addWidget(m_btnDelete);
    m_toolLayout->addWidget(m_btnRefresh);
    m_toolLayout->addWidget(m_btnExport);
    m_toolLayout->addWidget(m_btnViewHistory);
    m_toolLayout->addStretch();
    
    m_mainLayout->addLayout(m_toolLayout);
    
    // ÊêúÁ¥¢Âå∫Âüü
    m_searchGroup = new QGroupBox("ÊêúÁ¥¢Êù°‰ª∂", this);
    UIStyleManager::applyGroupBoxStyle(m_searchGroup);
    
    QHBoxLayout* searchLayout = new QHBoxLayout(m_searchGroup);
    searchLayout->setSpacing(10);
    
    searchLayout->addWidget(new QLabel("ÂÖ≥ÈîÆÂ≠ó:", this));
    m_searchEdit = new QLineEdit(this);
    m_searchEdit->setPlaceholderText("ÊêúÁ¥¢Áî®Êà∑Âêç„ÄÅÁúüÂÆûÂßìÂêç„ÄÅÁîµËØùÊàñÈÇÆÁÆ±...");
    UIStyleManager::applyLineEditStyle(m_searchEdit);
    searchLayout->addWidget(m_searchEdit);
    
    m_btnSearch = new QPushButton("üîç ÊêúÁ¥¢", this);
    UIStyleManager::applyButtonStyle(m_btnSearch, "primary");
    searchLayout->addWidget(m_btnSearch);
    
    m_mainLayout->addWidget(m_searchGroup);
    
    // ÊÇ£ËÄÖÂàóË°®Ë°®Ê†º
    m_patientTable = new QTableWidget(this);
    m_patientTable->setColumnCount(6);
    QStringList headers = {"Áî®Êà∑Âêç", "ÁúüÂÆûÂßìÂêç", "ÈÇÆÁÆ±", "ÁîµËØù", "Ê≥®ÂÜåÊó∂Èó¥", "Áä∂ÊÄÅ"};
    m_patientTable->setHorizontalHeaderLabels(headers);
    
    // ËÆæÁΩÆË°®Ê†ºÂ±ûÊÄß
    m_patientTable->setSelectionBehavior(QAbstractItemView::SelectRows);
    m_patientTable->setSelectionMode(QAbstractItemView::SingleSelection);
    m_patientTable->setAlternatingRowColors(true);
    m_patientTable->setSortingEnabled(true);
    
    // UIStyleManager::applyTableStyle(m_patientTable); // ÊöÇÊó∂Ê≥®ÈáäÊéâ
    m_mainLayout->addWidget(m_patientTable);
    
    // ÁªüËÆ°‰ø°ÊÅØ
    m_statsLabel = new QLabel("ÂÖ± 0 ‰ΩçÊÇ£ËÄÖ", this);
    m_statsLabel->setStyleSheet("color: #7F8C8D; font-size: 12px;");
    m_mainLayout->addWidget(m_statsLabel);
    
    // ËøûÊé•‰ø°Âè∑ÊßΩ
    connect(m_btnRefresh, &QPushButton::clicked, this, &PatientManageWidget::onRefreshPatients);
    connect(m_btnAdd, &QPushButton::clicked, this, &PatientManageWidget::onAddPatient);
    connect(m_btnEdit, &QPushButton::clicked, this, &PatientManageWidget::onEditPatient);
    connect(m_btnDelete, &QPushButton::clicked, this, &PatientManageWidget::onDeletePatient);
    connect(m_btnExport, &QPushButton::clicked, this, &PatientManageWidget::onExportPatients);
    connect(m_btnViewHistory, &QPushButton::clicked, this, &PatientManageWidget::onViewPatientHistory);
    connect(m_btnSearch, &QPushButton::clicked, this, &PatientManageWidget::onSearchPatients);
    connect(m_patientTable, &QTableWidget::itemSelectionChanged, this, &PatientManageWidget::onPatientSelectionChanged);
    
    // ÂàùÂßãÁä∂ÊÄÅÔºöÁ¶ÅÁî®ÁºñËæëÂíåÂà†Èô§ÊåâÈíÆ
    m_btnEdit->setEnabled(false);
    m_btnDelete->setEnabled(false);
    m_btnViewHistory->setEnabled(false);
}

void PatientManageWidget::loadPatients()
{
    if (!m_dbManager) return;
    
    m_patients = m_dbManager->getUsersByRole("ÊÇ£ËÄÖ");
    
    m_patientTable->setRowCount(m_patients.size());
    
    for (int i = 0; i < m_patients.size(); ++i) {
        addPatientToTable(i, m_patients[i]);
    }
    
    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
    m_statsLabel->setText(QString("ÂÖ± %1 ‰ΩçÊÇ£ËÄÖ").arg(m_patients.size()));
}

void PatientManageWidget::addPatientToTable(int row, const UserInfo& patient)
{
    m_patientTable->setItem(row, 0, new QTableWidgetItem(patient.username));
    m_patientTable->setItem(row, 1, new QTableWidgetItem(patient.realName));
    m_patientTable->setItem(row, 2, new QTableWidgetItem(patient.email));
    m_patientTable->setItem(row, 3, new QTableWidgetItem(patient.phone));
    m_patientTable->setItem(row, 4, new QTableWidgetItem(patient.createdAt.toString("yyyy-MM-dd hh:mm")));
    
    QString statusText = patient.status == 1 ? "ÂêØÁî®" : "Á¶ÅÁî®";
    QTableWidgetItem* statusItem = new QTableWidgetItem(statusText);
    statusItem->setForeground(patient.status == 1 ? QColor("#27AE60") : QColor("#E74C3C"));
    m_patientTable->setItem(row, 5, statusItem);
}

void PatientManageWidget::onRefreshPatients()
{
    loadPatients();
}

void PatientManageWidget::onSearchPatients()
{
    QString keyword = m_searchEdit->text().trimmed().toLower();
    
    for (int i = 0; i < m_patientTable->rowCount(); ++i) {
        bool show = true;
        
        if (!keyword.isEmpty()) {
            bool found = false;
            for (int j = 0; j < 4; ++j) {
                QTableWidgetItem* item = m_patientTable->item(i, j);
                if (item && item->text().toLower().contains(keyword)) {
                    found = true;
                    break;
                }
            }
            if (!found) show = false;
        }
        
        m_patientTable->setRowHidden(i, !show);
    }
}

void PatientManageWidget::onAddPatient() 
{
    showPatientDialog();
}

void PatientManageWidget::onEditPatient() 
{
    int currentRow = m_patientTable->currentRow();
    if (currentRow < 0 || currentRow >= m_patients.size()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁºñËæëÁöÑÊÇ£ËÄÖÔºÅ");
        return;
    }
    
    showPatientDialog(m_patients[currentRow]);
}

void PatientManageWidget::onDeletePatient() 
{
    int currentRow = m_patientTable->currentRow();
    if (currentRow < 0 || currentRow >= m_patients.size()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊÇ£ËÄÖÔºÅ");
        return;
    }
    
    UserInfo patient = m_patients[currentRow];
    int ret = QMessageBox::question(this, "Á°ÆËÆ§Âà†Èô§", 
                                   QString("Á°ÆÂÆöË¶ÅÂà†Èô§ÊÇ£ËÄÖ %1 (%2) ÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ")
                                   .arg(patient.realName.isEmpty() ? patient.username : patient.realName)
                                   .arg(patient.username),
                                   QMessageBox::Yes | QMessageBox::No);
    
    if (ret == QMessageBox::Yes) {
        // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®Êï∞ÊçÆÂ∫ìÂà†Èô§ÊñπÊ≥ïÔºåÁî±‰∫éDatabaseManagerÊ≤°ÊúâÂà†Èô§Áî®Êà∑ÁöÑÊñπÊ≥ïÔºåÊàë‰ª¨ÂÖàÁ¶ÅÁî®Áî®Êà∑
        patient.status = 0; // Á¶ÅÁî®Áî®Êà∑
        if (m_dbManager && m_dbManager->updateUserInfo(patient)) {
            QMessageBox::information(this, "ÊàêÂäü", "ÊÇ£ËÄÖÂ∑≤ÊàêÂäüÂà†Èô§ÔºÅ");
            onRefreshPatients();
        } else {
            QMessageBox::critical(this, "ÈîôËØØ", "Âà†Èô§ÊÇ£ËÄÖÂ§±Ë¥•ÔºÅ");
        }
    }
}

void PatientManageWidget::onPatientSelectionChanged() 
{
    int currentRow = m_patientTable->currentRow();
    bool hasSelection = (currentRow >= 0 && currentRow < m_patients.size());
    
    m_btnEdit->setEnabled(hasSelection);
    m_btnDelete->setEnabled(hasSelection);
    m_btnViewHistory->setEnabled(hasSelection);
}

void PatientManageWidget::onExportPatients() 
{
    QString fileName = QFileDialog::getSaveFileName(this, 
                                                   "ÂØºÂá∫ÊÇ£ËÄÖÊï∞ÊçÆ", 
                                                   QString("patients_%1.csv").arg(QDate::currentDate().toString("yyyyMMdd")),
                                                   "CSVÊñá‰ª∂ (*.csv)");
    
    if (!fileName.isEmpty()) {
        QFile file(fileName);
        if (file.open(QIODevice::WriteOnly | QIODevice::Text)) {
            QTextStream stream(&file);
            stream.setEncoding(QStringConverter::Utf8);
            
            // ÂÜôÂÖ•Ë°®Â§¥
            stream << "Áî®Êà∑Âêç,ÁúüÂÆûÂßìÂêç,ÈÇÆÁÆ±,ÁîµËØù,Ê≥®ÂÜåÊó∂Èó¥,Áä∂ÊÄÅ\n";
            
            // ÂÜôÂÖ•Êï∞ÊçÆ
            for (const UserInfo& patient : m_patients) {
                stream << QString("%1,%2,%3,%4,%5,%6\n")
                         .arg(patient.username)
                         .arg(patient.realName)
                         .arg(patient.email)
                         .arg(patient.phone)
                         .arg(patient.createdAt.toString("yyyy-MM-dd hh:mm:ss"))
                         .arg(patient.status == 1 ? "ÂêØÁî®" : "Á¶ÅÁî®");
            }
            
            file.close();
            QMessageBox::information(this, "ÊàêÂäü", QString("ÊÇ£ËÄÖÊï∞ÊçÆÂ∑≤ÂØºÂá∫Âà∞Ôºö%1").arg(fileName));
        } else {
            QMessageBox::critical(this, "ÈîôËØØ", "ÂØºÂá∫Êñá‰ª∂Â§±Ë¥•ÔºÅ");
        }
    }
}

void PatientManageWidget::onViewPatientHistory() 
{
    int currentRow = m_patientTable->currentRow();
    if (currentRow < 0 || currentRow >= m_patients.size()) {
        QMessageBox::warning(this, "ÊèêÁ§∫", "ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊü•ÁúãÂéÜÂè≤ÁöÑÊÇ£ËÄÖÔºÅ");
        return;
    }
    
    UserInfo patient = m_patients[currentRow];
    
    // ÂàõÂª∫ÂéÜÂè≤Êü•ÁúãÂØπËØùÊ°Ü
    QDialog* historyDialog = new QDialog(this);
    historyDialog->setWindowTitle(QString("ÊÇ£ËÄÖÂéÜÂè≤ - %1").arg(patient.realName.isEmpty() ? patient.username : patient.realName));
    historyDialog->resize(800, 600);
    
    QVBoxLayout* layout = new QVBoxLayout(historyDialog);
    
    // ÊÇ£ËÄÖÂü∫Êú¨‰ø°ÊÅØ
    QGroupBox* infoGroup = new QGroupBox("Âü∫Êú¨‰ø°ÊÅØ", historyDialog);
    QGridLayout* infoLayout = new QGridLayout(infoGroup);
    infoLayout->addWidget(new QLabel("Áî®Êà∑Âêç:"), 0, 0);
    infoLayout->addWidget(new QLabel(patient.username), 0, 1);
    infoLayout->addWidget(new QLabel("ÁúüÂÆûÂßìÂêç:"), 0, 2);
    infoLayout->addWidget(new QLabel(patient.realName), 0, 3);
    infoLayout->addWidget(new QLabel("ÈÇÆÁÆ±:"), 1, 0);
    infoLayout->addWidget(new QLabel(patient.email), 1, 1);
    infoLayout->addWidget(new QLabel("ÁîµËØù:"), 1, 2);
    infoLayout->addWidget(new QLabel(patient.phone), 1, 3);
    infoLayout->addWidget(new QLabel("Ê≥®ÂÜåÊó∂Èó¥:"), 2, 0);
    infoLayout->addWidget(new QLabel(patient.createdAt.toString("yyyy-MM-dd hh:mm:ss")), 2, 1);
    infoLayout->addWidget(new QLabel("ÊúÄÂêéÁôªÂΩï:"), 2, 2);
    infoLayout->addWidget(new QLabel(patient.lastLogin.toString("yyyy-MM-dd hh:mm:ss")), 2, 3);
    layout->addWidget(infoGroup);
    
    // ËÅäÂ§©‰ºöËØùÂéÜÂè≤
    QGroupBox* sessionGroup = new QGroupBox("ËÅäÂ§©‰ºöËØùÂéÜÂè≤", historyDialog);
    QVBoxLayout* sessionLayout = new QVBoxLayout(sessionGroup);
    
    QTableWidget* sessionTable = new QTableWidget(historyDialog);
    sessionTable->setColumnCount(4);
    sessionTable->setHorizontalHeaderLabels({"‰ºöËØùÊó∂Èó¥", "ÂÆ¢Êúç", "Áä∂ÊÄÅ", "ÊúÄÂêéÊ∂àÊÅØÊó∂Èó¥"});
    
    if (m_dbManager) {
        QList<ChatSession> sessions = m_dbManager->getPatientSessions(patient.id);
        sessionTable->setRowCount(sessions.size());
        
        for (int i = 0; i < sessions.size(); ++i) {
            sessionTable->setItem(i, 0, new QTableWidgetItem(sessions[i].createdAt.toString("yyyy-MM-dd hh:mm:ss")));
            sessionTable->setItem(i, 1, new QTableWidgetItem(sessions[i].staffName));
            QString statusText = sessions[i].status == 0 ? "Â∑≤ÁªìÊùü" : (sessions[i].status == 1 ? "ËøõË°å‰∏≠" : "Á≠âÂæÖ‰∏≠");
            sessionTable->setItem(i, 2, new QTableWidgetItem(statusText));
            sessionTable->setItem(i, 3, new QTableWidgetItem(sessions[i].lastMessageAt.toString("yyyy-MM-dd hh:mm:ss")));
        }
    }
    
    sessionTable->horizontalHeader()->setStretchLastSection(true);
    sessionLayout->addWidget(sessionTable);
    layout->addWidget(sessionGroup);
    
    // ÂÖ≥Èó≠ÊåâÈíÆ
    QPushButton* closeButton = new QPushButton("ÂÖ≥Èó≠", historyDialog);
    connect(closeButton, &QPushButton::clicked, historyDialog, &QDialog::accept);
    layout->addWidget(closeButton);
    
    historyDialog->exec();
    historyDialog->deleteLater();
}

void PatientManageWidget::showPatientDialog(const UserInfo& patient) 
{
    PatientEditDialog dialog(patient, this);
    if (dialog.exec() == QDialog::Accepted) {
        UserInfo newPatientInfo = dialog.getPatientInfo();
        
        if (patient.id > 0) {
            // ÁºñËæëÊ®°Âºè
            if (m_dbManager && m_dbManager->updateUserInfo(newPatientInfo)) {
                QMessageBox::information(this, "ÊàêÂäü", "ÊÇ£ËÄÖ‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ");
                onRefreshPatients();
            } else {
                QMessageBox::critical(this, "ÈîôËØØ", "Êõ¥Êñ∞ÊÇ£ËÄÖ‰ø°ÊÅØÂ§±Ë¥•ÔºÅ");
            }
        } else {
            // Êñ∞Â¢ûÊ®°Âºè
            if (m_dbManager && m_dbManager->registerUser(newPatientInfo.username, 
                                                        "123456", // ÈªòËÆ§ÂØÜÁ†Å
                                                        newPatientInfo.email,
                                                        newPatientInfo.phone,
                                                        "ÊÇ£ËÄÖ",
                                                        newPatientInfo.realName)) {
                QMessageBox::information(this, "ÊàêÂäü", "ÊÇ£ËÄÖÊ∑ªÂä†ÊàêÂäüÔºÅ\nÈªòËÆ§ÂØÜÁ†ÅÔºö123456");
                onRefreshPatients();
            } else {
                QMessageBox::critical(this, "ÈîôËØØ", "Ê∑ªÂä†ÊÇ£ËÄÖÂ§±Ë¥•ÔºÅÁî®Êà∑ÂêçÊàñÈÇÆÁÆ±ÂèØËÉΩÂ∑≤Â≠òÂú®„ÄÇ");
            }
        }
    }
}

// ========== PatientEditDialog ÂÆåÊï¥ÂÆûÁé∞ ==========

PatientEditDialog::PatientEditDialog(const UserInfo& patient, QWidget *parent)
    : QDialog(parent)
    , m_originalPatient(patient)
    , m_isEditing(patient.id > 0)
{
    setWindowTitle(m_isEditing ? "ÁºñËæëÊÇ£ËÄÖ‰ø°ÊÅØ" : "Ê∑ªÂä†Êñ∞ÊÇ£ËÄÖ");
    resize(450, 400);
    setupUI();
    
    if (m_isEditing) {
        // Â°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
        m_usernameEdit->setText(patient.username);
        m_realNameEdit->setText(patient.realName);
        m_emailEdit->setText(patient.email);
        m_phoneEdit->setText(patient.phone);
        m_statusCombo->setCurrentIndex(patient.status);
        m_usernameEdit->setEnabled(false); // ÁºñËæëÊ®°Âºè‰∏ãÁî®Êà∑Âêç‰∏çÂèØ‰øÆÊîπ
        m_passwordEdit->setPlaceholderText("ÁïôÁ©∫Ë°®Á§∫‰∏ç‰øÆÊîπÂØÜÁ†Å");
    }
}

void PatientEditDialog::setupUI() 
{
    QVBoxLayout* mainLayout = new QVBoxLayout(this);
    
    // Ë°®ÂçïÂå∫Âüü
    QGroupBox* formGroup = new QGroupBox("ÊÇ£ËÄÖ‰ø°ÊÅØ", this);
    m_formLayout = new QFormLayout(formGroup);
    
    m_usernameEdit = new QLineEdit(this);
    m_usernameEdit->setPlaceholderText("ËØ∑ËæìÂÖ•Áî®Êà∑Âêç");
    m_formLayout->addRow("Áî®Êà∑Âêç *:", m_usernameEdit);
    
    m_realNameEdit = new QLineEdit(this);
    m_realNameEdit->setPlaceholderText("ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç");
    m_formLayout->addRow("ÁúüÂÆûÂßìÂêç *:", m_realNameEdit);
    
    m_emailEdit = new QLineEdit(this);
    m_emailEdit->setPlaceholderText("ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ");
    m_formLayout->addRow("ÈÇÆÁÆ± *:", m_emailEdit);
    
    m_phoneEdit = new QLineEdit(this);
    m_phoneEdit->setPlaceholderText("ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å");
    m_formLayout->addRow("ÁîµËØù:", m_phoneEdit);
    
    m_passwordEdit = new QLineEdit(this);
    m_passwordEdit->setEchoMode(QLineEdit::Password);
    m_passwordEdit->setPlaceholderText(m_isEditing ? "ÁïôÁ©∫Ë°®Á§∫‰∏ç‰øÆÊîπ" : "ËØ∑ËæìÂÖ•ÂàùÂßãÂØÜÁ†Å");
    m_formLayout->addRow("ÂØÜÁ†Å:", m_passwordEdit);
    
    m_statusCombo = new QComboBox(this);
    m_statusCombo->addItem("Á¶ÅÁî®", 0);
    m_statusCombo->addItem("ÂêØÁî®", 1);
    m_statusCombo->setCurrentIndex(1); // ÈªòËÆ§ÂêØÁî®
    m_formLayout->addRow("Áä∂ÊÄÅ:", m_statusCombo);
    
    m_notesEdit = new QTextEdit(this);
    m_notesEdit->setPlaceholderText("Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ");
    m_notesEdit->setMaximumHeight(80);
    m_formLayout->addRow("Â§áÊ≥®:", m_notesEdit);
    
    mainLayout->addWidget(formGroup);
    
    // ÊåâÈíÆÂå∫Âüü
    QHBoxLayout* buttonLayout = new QHBoxLayout;
    
    m_okButton = new QPushButton(m_isEditing ? "‰øùÂ≠ò" : "Ê∑ªÂä†", this);
    m_cancelButton = new QPushButton("ÂèñÊ∂à", this);
    
    m_okButton->setDefault(true);
    
    buttonLayout->addStretch();
    buttonLayout->addWidget(m_okButton);
    buttonLayout->addWidget(m_cancelButton);
    
    mainLayout->addLayout(buttonLayout);
    
    // ËøûÊé•‰ø°Âè∑
    connect(m_okButton, &QPushButton::clicked, this, &PatientEditDialog::onAccept);
    connect(m_cancelButton, &QPushButton::clicked, this, &QDialog::reject);
    
    // ËæìÂÖ•È™åËØÅÂáΩÊï∞
    auto updateButtonState = [this]() {
        bool valid = !m_usernameEdit->text().trimmed().isEmpty() && 
                    !m_realNameEdit->text().trimmed().isEmpty() &&
                    !m_emailEdit->text().trimmed().isEmpty();
        m_okButton->setEnabled(valid);
    };
    
    connect(m_usernameEdit, &QLineEdit::textChanged, this, updateButtonState);
    connect(m_realNameEdit, &QLineEdit::textChanged, this, updateButtonState);
    connect(m_emailEdit, &QLineEdit::textChanged, this, updateButtonState);
    
    // ËÆæÁΩÆÂàùÂßãÊåâÈíÆÁä∂ÊÄÅ
    updateButtonState();
}

void PatientEditDialog::onAccept() 
{
    // È™åËØÅËæìÂÖ•
    QString username = m_usernameEdit->text().trimmed();
    QString realName = m_realNameEdit->text().trimmed();
    QString email = m_emailEdit->text().trimmed();
    QString phone = m_phoneEdit->text().trimmed();
    QString password = m_passwordEdit->text();
    
    if (username.isEmpty()) {
        QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÔºÅ");
        m_usernameEdit->setFocus();
        return;
    }
    
    if (realName.isEmpty()) {
        QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêçÔºÅ");
        m_realNameEdit->setFocus();
        return;
    }
    
    if (email.isEmpty()) {
        QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄÔºÅ");
        m_emailEdit->setFocus();
        return;
    }
    
    // È™åËØÅÈÇÆÁÆ±Ê†ºÂºè
    QRegularExpression emailRegex("^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$");
    if (!emailRegex.match(email).hasMatch()) {
        QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄÔºÅ");
        m_emailEdit->setFocus();
        return;
    }
    
    // È™åËØÅÊâãÊú∫Âè∑Ê†ºÂºèÔºàÂ¶ÇÊûúËæìÂÖ•‰∫ÜÁöÑËØùÔºâ
    if (!phone.isEmpty()) {
        QRegularExpression phoneRegex("^1[3-9]\\d{9}$");
        if (!phoneRegex.match(phone).hasMatch()) {
            QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊâãÊú∫Âè∑Á†ÅÔºÅ");
            m_phoneEdit->setFocus();
            return;
        }
    }
    
    // ÂØπ‰∫éÊñ∞Â¢ûÊÇ£ËÄÖÔºåÂØÜÁ†ÅÊòØÂøÖÂ°´ÁöÑ
    if (!m_isEditing && password.isEmpty()) {
        QMessageBox::warning(this, "ËæìÂÖ•ÈîôËØØ", "ËØ∑ËæìÂÖ•ÂàùÂßãÂØÜÁ†ÅÔºÅ");
        m_passwordEdit->setFocus();
        return;
    }
    
    accept();
}

UserInfo PatientEditDialog::getPatientInfo() const
{
    UserInfo info = m_originalPatient;
    
    info.username = m_usernameEdit->text().trimmed();
    info.realName = m_realNameEdit->text().trimmed();
    info.email = m_emailEdit->text().trimmed();
    info.phone = m_phoneEdit->text().trimmed();
    info.status = m_statusCombo->currentData().toInt();
    info.role = "ÊÇ£ËÄÖ";
    
    return info;
}

// MOC generated automatically 