# HospAI 聊天系统完整集成说明

## 系统概述

HospAI 现在包含了完整的智能分诊和人工客服聊天系统：

### 🤖 智能分诊系统
- **AI智能助手**：分析患者症状，推荐合适科室
- **快捷咨询**：预设常见问题，快速获得建议
- **转人工服务**：AI无法解决时，无缝转接人工客服
- **科室推荐**：基于症状匹配合适的医科科室

### 💬 人工客服系统
- **实时聊天**：患者与客服之间的实时消息交换
- **会话管理**：支持多个患者同时咨询
- **聊天历史**：完整的对话记录和历史查询
- **在线状态**：实时显示客服在线状态

## 系统架构

```
患者端                    数据库层                   客服端
┌─────────────┐          ┌─────────────┐           ┌─────────────┐
│ AI智能分诊  │          │   SQLite    │           │ 会话管理器  │
│  - 症状分析 │          │   数据库    │           │  - 等待队列 │
│  - 科室推荐 │    ↔     │ ┌─────────┐ │     ↔     │  - 活跃会话 │
│  - 转人工   │          │ │用户表   │ │           │  - 消息收发 │
└─────────────┘          │ │会话表   │ │           └─────────────┘
┌─────────────┐          │ │消息表   │ │           
│ 人工客服    │          │ └─────────┘ │           
│  - 实时聊天 │          └─────────────┘           
│  - 历史记录 │                                    
└─────────────┘                                    
```

## 功能特性

### 患者端功能

#### 1. AI智能分诊
- 📍 **症状分析**：输入症状描述，AI提供初步诊断建议
- 🏥 **科室推荐**：根据症状推荐合适的医院科室
- ⚡ **快捷按钮**：常见症状一键咨询
- 🚨 **紧急识别**：自动识别紧急情况，建议急诊
- 📅 **预约引导**：提供预约挂号流程指导

#### 2. 转人工服务
- 👤 **无缝转接**：AI聊天中一键转人工客服
- 📋 **上下文传递**：AI对话记录同步给客服
- 🔄 **双向切换**：可在AI和人工服务间自由切换
- 📱 **选项卡切换**：自动跳转到客服咨询界面

#### 3. 人工客服聊天
- 💬 **实时聊天**：与客服进行实时文字交流
- 📝 **消息历史**：查看完整的聊天记录
- 🔔 **状态提示**：显示连接状态和客服在线情况
- ⌨️ **便捷输入**：支持回车发送，多行输入

### 客服端功能

#### 1. 会话管理
- 📊 **会话列表**：查看所有等待和活跃的患者会话
- 🎯 **一键接受**：快速接受患者的咨询请求
- 📱 **多会话**：同时处理多个患者的咨询
- 🔄 **状态管理**：实时更新会话状态

#### 2. 聊天界面
- 💬 **实时通信**：与患者进行实时聊天
- 📜 **消息历史**：查看患者的历史咨询记录
- 🤖 **AI上下文**：查看患者之前与AI的对话内容
- ⏰ **时间戳**：显示详细的消息时间信息

## 测试指南

### 环境准备

1. **编译项目**
```bash
cd HospAI/build
make
```

2. **检查可执行文件**
```bash
ls -la HospAI  # 确保可执行文件存在
```

### 测试方法

#### 方法一：使用测试脚本（推荐）

```bash
# 启动多实例测试
./test_chat_system.sh multi

# 或分别启动不同角色
./test_chat_system.sh patient  # 患者端
./test_chat_system.sh staff    # 客服端
./test_chat_system.sh admin    # 管理员端
```

#### 方法二：手动启动多个实例

```bash
# 终端1 - 启动患者实例
cd build && ./HospAI

# 终端2 - 启动客服实例  
cd build && ./HospAI

# 终端3 - 启动另一个患者实例
cd build && ./HospAI
```

### 测试账号

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 管理员 | admin | admin123 | 系统管理员 |
| 客服1 | staff1 | staff123 | 客服人员 |
| 客服2 | staff2 | staff123 | 客服人员 |
| 患者1 | patient1 | patient123 | 患者用户 |
| 患者2 | patient2 | patient123 | 患者用户 |
| 患者3 | patient3 | patient123 | 患者用户 |

### 完整测试流程

#### 1. AI智能分诊测试

1. **登录患者账号**：使用 `patient1/patient123` 登录
2. **进入智能分诊**：默认在"🤖 智能分诊"选项卡
3. **测试症状咨询**：
   - 输入："我发烧了，体温39度"
   - 观察AI的回复和科室推荐
   - 点击快捷按钮测试预设问题
4. **测试紧急情况**：
   - 输入："胸痛呼吸困难"
   - 观察AI是否识别为紧急情况
5. **测试转人工**：
   - 点击"👤 转人工客服"快捷按钮
   - 或在AI回复中点击转人工选项

#### 2. 人工客服测试

1. **客服端准备**：
   - 启动另一个实例，登录 `staff1/staff123`
   - 进入客服界面，查看会话管理

2. **患者发起咨询**：
   - 在患者端点击转人工后，切换到"💬 客服咨询"选项卡
   - 点击"🚀 开始咨询"按钮
   - 发送消息："我需要人工客服帮助"

3. **客服接受会话**：
   - 在客服端查看等待队列中的新会话
   - 点击"接受"按钮接受患者咨询
   - 在右侧聊天界面回复患者

4. **实时聊天测试**：
   - 患者和客服之间发送多条消息
   - 验证消息实时性（2-3秒延迟）
   - 检查消息显示格式和时间戳

#### 3. 多用户测试

1. **启动三个实例**：
   - 实例1：patient1（患者1）
   - 实例2：staff1（客服）  
   - 实例3：patient2（患者2）

2. **同时咨询测试**：
   - 两个患者同时发起人工咨询
   - 客服接受并处理多个会话
   - 验证消息不会混乱

3. **负载测试**：
   - 快速发送多条消息
   - 测试系统稳定性

### 验证要点

#### ✅ AI智能分诊验证
- [ ] AI能理解症状描述并给出合理建议
- [ ] 快捷按钮功能正常
- [ ] 紧急情况能被正确识别
- [ ] 转人工功能可以正常触发
- [ ] 界面切换流畅

#### ✅ 人工客服验证  
- [ ] 患者能成功创建咨询会话
- [ ] 客服能看到等待中的会话
- [ ] 客服能正常接受和回复会话
- [ ] 消息实时传递（延迟<5秒）
- [ ] 聊天历史正确保存和显示

#### ✅ 系统集成验证
- [ ] 数据库正常创建和连接
- [ ] 用户登录和权限控制正常
- [ ] 多实例可以同时运行
- [ ] 界面样式美观统一
- [ ] 错误处理机制有效

## 技术实现

### 核心技术栈
- **UI框架**：Qt6 + C++
- **数据库**：SQLite 
- **通信机制**：Qt信号槽 + 定时器轮询
- **样式系统**：跨平台UI样式管理
- **架构模式**：MVC + 观察者模式

### 数据库设计

#### 用户表 (users)
```sql
- id: 用户ID
- username: 用户名
- password_hash: 密码哈希
- email: 邮箱
- phone: 电话
- role: 角色(管理员/客服/患者)
- real_name: 真实姓名
- created_at: 创建时间
- last_login: 最后登录时间
- status: 用户状态
```

#### 聊天会话表 (chat_sessions)
```sql
- id: 会话ID
- patient_id: 患者ID
- staff_id: 客服ID  
- status: 状态(waiting/active/closed)
- created_at: 创建时间
- updated_at: 更新时间
```

#### 聊天消息表 (chat_messages)
```sql
- id: 消息ID
- session_id: 会话ID
- sender_id: 发送者ID
- sender_name: 发送者姓名
- content: 消息内容
- message_type: 消息类型
- timestamp: 发送时间
- is_read: 是否已读
```

### 实时通信机制

```cpp
// 患者端 - 2秒轮询检查新消息
m_updateTimer = new QTimer(this);
connect(m_updateTimer, &QTimer::timeout, this, &ChatWidget::updateChatMessages);
m_updateTimer->start(2000);

// 客服端 - 3秒轮询检查新会话和消息  
m_updateTimer = new QTimer(this);
connect(m_updateTimer, &QTimer::timeout, this, &StaffChatManager::updateSessions);
m_updateTimer->start(3000);
```

## 故障排除

### 常见问题

#### 1. 编译失败
```bash
# 清理重新编译
cd build
make clean
cmake ..
make
```

#### 2. 数据库错误
```bash
# 删除数据库文件重新创建
rm -rf ~/.local/share/HospAI/
```

#### 3. 消息不实时
- 检查网络连接
- 确认数据库文件权限
- 重启应用程序

#### 4. 界面显示异常
- 检查Qt版本兼容性
- 确认字体安装
- 尝试切换系统主题

### 调试方法

#### 启用详细日志
```cpp
qDebug() << "数据库操作:" << query.lastError().text();
```

#### 检查数据库内容
```bash
sqlite3 ~/.local/share/HospAI/hospai.db
.tables  # 查看所有表
SELECT * FROM chat_sessions;  # 查看会话
SELECT * FROM chat_messages;  # 查看消息
```

## 扩展开发

### 添加新功能
1. **图片消息**：扩展消息类型支持图片
2. **文件传输**：支持文档和文件发送
3. **语音消息**：集成语音录制和播放
4. **视频通话**：添加视频通话功能
5. **推送通知**：系统级消息推送

### 性能优化
1. **消息分页**：大量历史消息分页加载
2. **连接池**：优化数据库连接管理
3. **缓存机制**：常用数据内存缓存
4. **压缩传输**：消息内容压缩

### 部署建议
1. **多用户环境**：配置用户隔离
2. **网络部署**：替换SQLite为网络数据库
3. **安全加固**：消息加密传输
4. **监控告警**：系统运行状态监控

---

## 总结

HospAI 聊天系统成功集成了AI智能分诊和人工客服功能，提供了完整的患者咨询解决方案。系统支持多用户同时使用，具有良好的实时性和可靠性。

通过本文档的指导，您可以：
- ✅ 完整测试所有聊天功能
- ✅ 验证系统集成效果  
- ✅ 了解技术实现原理
- ✅ 进行故障排除和扩展开发

祝您使用愉快！如有问题，请参考故障排除部分或联系开发团队。 