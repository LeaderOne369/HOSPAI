# HospAI 实时聊天系统

## 🚀 项目简介

HospAI 是一个基于 Qt6 开发的医院智慧客服系统，支持患者与客服之间的实时聊天功能。该系统实现了完整的多用户聊天架构，一个客服可以同时处理多个患者的咨询。

## ✨ 主要功能

### 患者端功能
- 🔐 用户登录认证
- 💬 发起新的咨询会话
- 📝 实时发送/接收消息
- 📱 现代化的聊天气泡界面
- ⏰ 消息时间显示
- 🔄 自动检测新消息

### 客服端功能
- 👥 多会话管理界面
- 📋 等待接入会话列表
- 🎯 一键接入患者对话
- 💼 同时管理多个活跃会话
- 📊 会话状态实时更新
- 🔚 结束对话功能

### 系统特性
- 🗄️ SQLite 数据库存储
- 🔄 实时消息推送（基于定时器轮询）
- 👤 用户在线状态管理
- 📝 完整的聊天历史记录
- 🎨 跨平台 UI 优化
- 🛡️ 用户角色权限管理

## 🏗️ 系统架构

### 数据库设计

#### 用户表 (users)
```sql
- id: 用户ID (主键)
- username: 用户名
- password_hash: 密码哈希
- email: 邮箱
- phone: 手机号
- role: 角色 (患者/客服/管理员)
- real_name: 真实姓名
- created_at: 创建时间
- last_login: 最后登录时间
- status: 状态 (1-启用, 0-禁用)
- is_online: 在线状态
```

#### 聊天会话表 (chat_sessions)
```sql
- id: 会话ID (主键)
- patient_id: 患者ID
- staff_id: 客服ID
- patient_name: 患者姓名
- staff_name: 客服姓名
- created_at: 创建时间
- last_message_at: 最后消息时间
- status: 状态 (0-已结束, 1-进行中, 2-等待中)
- last_message: 最后一条消息
```

#### 聊天消息表 (chat_messages)
```sql
- id: 消息ID (主键)
- session_id: 会话ID
- sender_id: 发送者ID
- sender_name: 发送者姓名
- sender_role: 发送者角色
- content: 消息内容
- timestamp: 时间戳
- message_type: 消息类型 (0-普通, 1-系统)
- is_read: 是否已读
```

### 核心组件

#### DatabaseManager
- 数据库管理单例类
- 用户认证和管理
- 聊天会话和消息的 CRUD 操作
- 实时消息信号发送

#### RealChatWidget (患者端)
- 患者聊天界面组件
- 消息发送/接收
- 聊天历史显示
- 连接状态管理

#### StaffChatManager (客服端)
- 客服多会话管理界面
- 会话列表显示和切换
- 新会话接入
- 消息处理和回复

## 🛠️ 技术栈

- **框架**: Qt6 (C++)
- **数据库**: SQLite
- **架构**: MVC 模式
- **UI**: 现代化扁平设计
- **通信**: 信号槽机制 + 定时器轮询

## 📦 安装和运行

### 系统要求
- Qt6.0 或更高版本
- CMake 3.16+
- C++17 编译器
- SQLite3

### 编译步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd HospAI
```

2. **编译聊天演示程序**
```bash
mkdir -p chat_demo_build
cd chat_demo_build
cp ../chat_demo_CMakeLists.txt CMakeLists.txt
cp ../chat_demo.cpp .
cmake .
make
```

3. **运行演示**
```bash
# 使用启动脚本
cd ..
./start_chat_demo.sh

# 或直接运行
cd chat_demo_build
./ChatDemo
```

## 🎮 使用指南

### 快速开始

1. **启动演示程序**
   ```bash
   ./start_chat_demo.sh
   ```

2. **选择启动模式**
   - 选项 4: 启动多个演示窗口 (推荐)

3. **模拟患者操作**
   - 在第一个窗口点击「模拟患者登录」
   - 点击「🚀 开始咨询」按钮
   - 输入问题并发送消息

4. **模拟客服操作**
   - 在第二个窗口点击「模拟客服登录」
   - 在「等待接入」列表中双击患者会话
   - 开始回复患者消息

5. **实时聊天**
   - 两个窗口间可以实时收发消息
   - 支持 Enter 发送，Shift+Enter 换行

### 多用户测试

可以启动多个进程模拟更多用户：

```bash
# 终端1 - 患者1
./ChatDemo &

# 终端2 - 患者2  
./ChatDemo &

# 终端3 - 客服1
./ChatDemo &

# 终端4 - 客服2
./ChatDemo &
```

## 🧪 测试账户

系统自动创建以下测试账户：

| 用户名 | 密码 | 角色 | 姓名 |
|--------|------|------|------|
| admin | admin123 | 管理员 | 系统管理员 |
| staff1 | 123456 | 客服 | 客服小王 |
| staff2 | 123456 | 客服 | 客服小李 |
| patient1 | 123456 | 患者 | 张三 |
| patient2 | 123456 | 患者 | 李四 |
| patient3 | 123456 | 患者 | 王五 |

## 🔧 配置说明

### 数据库位置
```
~/.local/share/HospAI/hospai.db
```

### 消息检测间隔
- 新消息检测: 2秒
- 新会话检测: 3秒

### UI 样式
- 自己的消息: 蓝色气泡，右对齐
- 对方的消息: 灰色气泡，左对齐  
- 系统消息: 浅灰色气泡，居中

## 🚀 扩展功能

### 已实现
- ✅ 实时消息传递
- ✅ 多会话管理
- ✅ 用户在线状态
- ✅ 消息已读状态
- ✅ 聊天历史记录
- ✅ 会话状态管理

### 待扩展
- 🔄 WebSocket 实时通信
- 📁 文件传输支持
- 🔔 消息推送通知
- 📊 聊天数据统计
- 🌐 Web 端支持
- 📱 移动端适配

## 🐛 故障排除

### 常见问题

1. **编译错误**
   - 确保 Qt6 正确安装
   - 检查 CMake 版本 >= 3.16

2. **数据库连接失败**
   - 检查目录权限
   - 删除旧数据库文件重新创建

3. **消息不实时**
   - 当前使用轮询机制，有2-3秒延迟
   - 可考虑升级到 WebSocket

4. **界面显示异常**
   - 检查系统字体支持
   - 尝试调整窗口大小

## 📞 技术支持

如遇到问题，请检查：
1. 控制台错误信息
2. 数据库文件权限
3. Qt6 环境配置

## 📄 许可证

本项目仅供学习和演示使用。

---

**🎉 现在可以开始体验 HospAI 实时聊天系统了！**

启动脚本将自动创建测试数据，你可以立即开始多用户聊天测试。 